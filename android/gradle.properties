      - name: Configure signing (gradle.properties, guarded)
        shell: bash
        run: |
          set -euo pipefail
          PROP_FILE="android/gradle.properties"

          # Start from existing file but drop any old MYAPP_* lines
          ( [[ -f "$PROP_FILE" ]] && grep -v '^MYAPP_' "$PROP_FILE" || true ) > "$PROP_FILE.tmp" || true
          mv "$PROP_FILE.tmp" "$PROP_FILE"

          # Only add signing props if a keystore and all secrets are present
          if [[ -n "${KEYSTORE_B64:-}" && -n "${KEYSTORE_PASSWORD:-}" && -n "${KEY_ALIAS:-}" && -n "${KEY_ALIAS_PASSWORD:-}" ]]; then
            echo "$KEYSTORE_B64" | base64 -d > android/app/upload.keystore
            {
              echo "MYAPP_STORE_FILE=app/upload.keystore"
              echo "MYAPP_STORE_PASSWORD=${KEYSTORE_PASSWORD}"
              echo "MYAPP_KEY_ALIAS=${KEY_ALIAS}"
              echo "MYAPP_KEY_PASSWORD=${KEY_ALIAS_PASSWORD}"
            } >> "$PROP_FILE"
            echo "Signing props set with path app/upload.keystore"
          else
            echo "::notice::Signing secrets missing; build will be unsigned."
          fi

          # Ensure AndroidX flags are present
          grep -q '^android.useAndroidX=' "$PROP_FILE" || echo 'android.useAndroidX=true' >> "$PROP_FILE"
          grep -q '^android.enableJetifier=' "$PROP_FILE" || echo 'android.enableJetifier=true' >> "$PROP_FILE"
